name: Notify New Blog Post

on:
  push:
    paths:
      - 'content/posts/**.md'

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2   # â­ å…³é”®ï¼šä¿è¯ HEAD~1 å­˜åœ¨

      - name: Parse new post info
        id: post
        shell: bash
        run: |
          # 1. æ‰¾åˆ°æœ€è¿‘ä¸€æ¬¡æäº¤ä¸­å˜åŠ¨çš„æ–‡ç« 
          FILE=$(git diff --name-only HEAD~1 HEAD \
            | grep '^content/posts/.*\.md' \
            | head -n 1)

          if [ -z "$FILE" ]; then
            echo "No post file found."
            exit 0
          fi

          echo "Detected post file: $FILE"

          # 2. è¯»å– Front Matter
          FRONT=$(sed -n '/^---$/,/^---$/p' "$FILE")

          # 3. draft è¿‡æ»¤
          DRAFT=$(echo "$FRONT" | sed -n 's/^[[:space:]]*draft:[[:space:]]*//p' | head -n 1)
          if [ "$DRAFT" = "true" ]; then
            echo "Post is draft, skip notification."
            exit 0
          fi

          # 4. title
          TITLE=$(echo "$FRONT" | sed -n 's/^[[:space:]]*title:[[:space:]]*//p' | head -n 1)

          # 5. slugï¼ˆä¼˜å…ˆï¼‰
          SLUG=$(echo "$FRONT" | sed -n 's/^[[:space:]]*slug:[[:space:]]*//p' | head -n 1)
          if [ -z "$SLUG" ]; then
            SLUG=$(basename "$FILE" .md)
          fi

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "url=https://onedayoneday.xin/posts/$SLUG/" >> $GITHUB_OUTPUT

      - name: Send email to subscribers
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USER }}
          password: ${{ secrets.MAIL_PASS }}

          to: ${{ secrets.SUBSCRIBERS }}
          from: "OneDay Blog Bot <${{ secrets.MAIL_USER }}>"
          subject: "ğŸ“¢ æ–°æ–‡ç« å‘å¸ƒï¼šã€Š${{ steps.post.outputs.title }}ã€‹"

          body: |
            ä½ å¥½ ğŸ‘‹

            OneDay çš„åšå®¢åˆšåˆšå‘å¸ƒäº†ä¸€ç¯‡æ–°æ–‡ç« ï¼š

            ğŸ“Œ æ ‡é¢˜ï¼š${{ steps.post.outputs.title }}
            ğŸ”— é“¾æ¥ï¼š${{ steps.post.outputs.url }}

            æ¬¢è¿é˜…è¯»ï½