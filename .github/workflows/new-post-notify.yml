name: Notify New Blog Post

on:
  push:
    paths:
      - 'content/posts/**.md'

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Parse new post info
        id: post
        shell: bash
        run: |
          # 1. æ‰¾åˆ°æœ¬æ¬¡ push ä¸­å˜åŠ¨çš„æ–‡ç« ï¼ˆåªå–ç¬¬ä¸€ç¯‡ï¼‰
          FILE=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} \
            | grep '^content/posts/.*\.md' \
            | head -n 1)

          if [ -z "$FILE" ]; then
            echo "No post file found."
            exit 0
          fi

          echo "Detected post file: $FILE"

          # 2. è¯»å– Front Matterï¼ˆ--- åŒ…è£¹éƒ¨åˆ†ï¼‰
          FRONT=$(sed -n '/^---$/,/^---$/p' "$FILE")

          # 3. è§£æ draftï¼Œè‰ç¨¿ç›´æ¥é€€å‡ºï¼ˆä¸å‘é‚®ä»¶ï¼‰
          DRAFT=$(echo "$FRONT" | sed -n 's/^[[:space:]]*draft:[[:space:]]*//p' | head -n 1)
          if [ "$DRAFT" = "true" ]; then
            echo "Post is draft, skip notification."
            exit 0
          fi

          # 4. è§£æ titleï¼ˆå…è®¸å‰é¢æœ‰ç©ºæ ¼ï¼‰
          TITLE=$(echo "$FRONT" | sed -n 's/^[[:space:]]*title:[[:space:]]*//p' | head -n 1)

          # 5. è§£æ slugï¼ˆä¼˜å…ˆç”¨ slugï¼‰
          SLUG=$(echo "$FRONT" | sed -n 's/^[[:space:]]*slug:[[:space:]]*//p' | head -n 1)

          if [ -z "$SLUG" ]; then
            SLUG=$(basename "$FILE" .md)
          fi

          # 6. è¾“å‡ºç»™åç»­ steps ä½¿ç”¨
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "url=https://onedayoneday.xin/posts/$SLUG/" >> $GITHUB_OUTPUT

      - name: Send email to subscribers
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USER }}
          password: ${{ secrets.MAIL_PASS }}

          to: ${{ secrets.SUBSCRIBERS }}
          from: "OneDay Blog <${{ secrets.MAIL_USER }}>"

          subject: "ğŸ“¢ æ–°æ–‡ç« å‘å¸ƒï¼šã€Š${{ steps.post.outputs.title }}ã€‹"

          body: |
            ä½ å¥½ ğŸ‘‹

            OneDay çš„åšå®¢åˆšåˆšå‘å¸ƒäº†ä¸€ç¯‡æ–°æ–‡ç« ï¼š

            ğŸ“Œ æ ‡é¢˜ï¼š${{ steps.post.outputs.title }}
            ğŸ”— é“¾æ¥ï¼š${{ steps.post.outputs.url }}

            æ¬¢è¿é˜…è¯»ï½