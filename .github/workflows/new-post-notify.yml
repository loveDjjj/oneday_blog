name: Notify New Blog Post

on:
  push:
    paths:
      - 'content/posts/**.md'

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get changed post
        id: post
        run: |
          FILE=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^content/posts/.*\.md' | head -n 1)
          echo "file=$FILE" >> $GITHUB_OUTPUT

          TITLE=$(grep '^title:' "$FILE" | head -n 1 | sed 's/title:[ ]*//')
          SLUG=$(basename "$FILE" .md)

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "url=https://onedayoneday.xin/posts/$SLUG/" >> $GITHUB_OUTPUT

      - name: Send email to subscribers
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USER }}
          password: ${{ secrets.MAIL_PASS }}

          subject: "ğŸ“¢ OneDay Blogæ–°æ–‡ç« å‘å¸ƒï¼šã€Š${{ steps.post.outputs.title }}ã€‹"
          to: ${{ secrets.SUBSCRIBERS }}
          from: "OneDay Blog Bot <${{ secrets.MAIL_USER }}>"
          body: |
            ä½ å¥½ ğŸ‘‹

            Onedayçš„åšå®¢åˆšåˆšå‘å¸ƒäº†ä¸€ç¯‡æ–°æ–‡ç« ï¼š

            ğŸ“Œ æ ‡é¢˜ï¼š${{ steps.post.outputs.title }}
            ğŸ”— é“¾æ¥ï¼š${{ steps.post.outputs.url }}

            æ¬¢è¿é˜…è¯»ï½