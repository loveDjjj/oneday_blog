name: Notify New Blog Post

on:
  push:
    paths:
      - 'content/posts/**.md'

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Parse new post info
        id: post
        shell: bash
        run: |
          set -e

          # 1. æ‰¾åˆ°æœ€è¿‘ä¸€æ¬¡æäº¤ä¸­å˜åŠ¨çš„æ–‡ç« 
          FILE=$(git diff --name-only HEAD~1 HEAD \
            | grep '^content/posts/.*\.md' \
            | head -n 1)

          if [ -z "$FILE" ]; then
            echo "send=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Detected post file: $FILE"

          # 2. ç”¨ awk ç¨³å®šè§£æ Front Matter
          FRONT=$(awk '
            BEGIN{in_fm=0}
            /^---[[:space:]]*$/ {
              if(in_fm==0){in_fm=1; next}
              else{exit}
            }
            in_fm==1 {print}
          ' "$FILE")

          # 3. è§£æ draft
          Send_Email=$(echo "$FRONT" | awk -F: '/^send_email[[:space:]]*:/ {gsub(/ /,"",$2); print $2}')

          if [ "$Send_Email" = "false" ]; then
            echo "Draft post, skip notify."
            echo "send=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 4. title
          TITLE=$(echo "$FRONT" | awk -F: '/^title[[:space:]]*:/ {sub(/^ /,"",$2); print $2}')

          # 5. slugï¼ˆä¼˜å…ˆï¼‰
          SLUG=$(echo "$FRONT" | awk -F: '/^slug[[:space:]]*:/ {sub(/^ /,"",$2); print $2}')
          if [ -z "$SLUG" ]; then
            SLUG=$(basename "$FILE" .md)
          fi

          echo "send=true" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "url=https://onedayoneday.xin/posts/$SLUG/" >> $GITHUB_OUTPUT

      - name: Send email to subscribers
        if: steps.post.outputs.send == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USER }}
          password: ${{ secrets.MAIL_PASS }}

          to: ${{ secrets.SUBSCRIBERS }}
          from: "OneDay Blog Bot <${{ secrets.MAIL_USER }}>"
          subject: "ğŸ“¢ æ–°æ–‡ç« å‘å¸ƒï¼šã€Š${{ steps.post.outputs.title }}ã€‹"

          body: |
            ä½ å¥½ ğŸ‘‹

            OneDay çš„åšå®¢åˆšåˆšå‘å¸ƒäº†ä¸€ç¯‡æ–°æ–‡ç« ï¼š

            ğŸ“Œ æ ‡é¢˜ï¼š${{ steps.post.outputs.title }}
            ğŸ”— é“¾æ¥ï¼š${{ steps.post.outputs.url }}

            æ¬¢è¿é˜…è¯»ï½